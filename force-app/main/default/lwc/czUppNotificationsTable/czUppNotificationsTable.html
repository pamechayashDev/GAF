<template>
  <lightning-card hide-header="true" label="" style="position: relative">
    <template if:false={isParent}>
      <div class="filter-container-cover">
        <div class="filter-container">
          <div class="filter-group">
            <label>Display</label>
            <lightning-combobox
              name="displayValue"
              value={displayValue}
              placeholder={displayValue}
              options={displayOptions}
              onchange={handleChange}
            ></lightning-combobox>
          </div>
          <div class="filter-group">
            <label>Message Type</label>

            <lightning-combobox
              name="messageTypeValue"
              value={messageTypeValue}
              placeholder=""
              options={messageTypePicklistValue}
              onchange={handleChange}
            ></lightning-combobox>
          </div>
          <div class="dateContainer">
            <label>Date Sent</label>
            <div class="dates">
              <lightning-input
                type="date"
                placeholder="From"
                name="dateFrom"
                value={dateFrom}
                onchange={handleChange}
              ></lightning-input>
              <lightning-input
                type="date"
                name="dateTo"
                placeholder="To"
                value={dateTo}
                onchange={handleChange}
              ></lightning-input>
            </div>
          </div>
          <div class="filter-group">
            <lightning-input
              style="margin-top: 20px"
              type="checkbox"
              name="showArchived"
              label="Show Archived"
              checked={showArchived}
              onchange={handleChange}
            ></lightning-input>
          </div>
        </div>
        <div class="button-group">
          <div class="clear-button" onclick={clearFilters}>Clear Filters</div>

          <lightning-button
            label="Apply Filters"
            onclick={applyFilters}
            class="apply-button"
            variant="destructive"
          ></lightning-button>

          <lightning-button
            label="Archive"
            data-from="Multiple"
            onclick={archiveSelectedRecords}
            class="apply-button"
            variant="brand"
          ></lightning-button>

          <lightning-button
            label="Preferences"
            onclick={handlePreferencesButtonClick}
            variant="brand"
          >
          </lightning-button>

          <lightning-input
            type="number"
            class="recordCountInput"
            name="recordsPerPage"
            label="Records Per Page"
            onblur={handleRecordsPerPageOnBlur}
            value={recordsPerPage}
            onchange={handleChange}
          ></lightning-input>
        </div>
      </div>
    </template>

    <template if:true={notifications.length}>
      <table
        class="slds-table slds-table_bordered slds-table_fixed-layout slds-table_resizable-cols"
      >
        <thead>
          <tr class="slds-line-height_reset">
            <template if:false={isParent}>
              <th
                class="slds-text-align_center"
                data-column="Checkbox"
                scope="col"
                style="width: 3.2rem"
              >
                <lightning-input
                  type="checkbox"
                  label=""
                  checked={allSelected}
                  onchange={handleSelectAll}
                >
                </lightning-input>
                <div class="slds-resizable">
                  <span class="slds-resizable__handle">
                    <span
                      class="slds-resizable__divider"
                      data-column="Checkbox"
                      onmousedown={handleStartResize}
                    ></span>
                  </span>
                </div>
              </th>
            </template>
            <th
              class="slds-is-resizable"
              data-column="BusinessArea"
              scope="col"
            >
              <div
                class="slds-truncate slds-p-horizontal_xx-small slds-p-vertical_xx-small"
                title="Business Area"
              >
                <span
                  class="sortBtn"
                  data-field="Business_Area__c"
                  onclick={handleSort}
                  >Business Area</span
                >

                <lightning-icon
                  if:true={isBusinessAreaSortedAsc}
                  icon-name="utility:arrowup"
                  size="xx-small"
                ></lightning-icon>
                <lightning-icon
                  if:true={isBusinessAreaSortedDesc}
                  icon-name="utility:arrowdown"
                  size="xx-small"
                ></lightning-icon>
              </div>
              <div class="slds-resizable">
                <span class="slds-resizable__handle">
                  <span
                    class="slds-resizable__divider"
                    data-column="BusinessArea"
                    onmousedown={handleStartResize}
                  ></span>
                </span>
              </div>
            </th>
            <th class="slds-is-resizable" data-column="MessageType" scope="col">
              <div
                class="slds-truncate slds-p-horizontal_xx-small"
                title="Message Type"
              >
                <span
                  class="sortBtn"
                  data-field="Message_Type__c"
                  onclick={handleSort}
                  >Message Type</span
                >

                <lightning-icon
                  if:true={isMessageTypeSortedAsc}
                  icon-name="utility:arrowup"
                  size="xx-small"
                ></lightning-icon>
                <lightning-icon
                  if:true={isMessageTypeSortedDesc}
                  icon-name="utility:arrowdown"
                  size="xx-small"
                ></lightning-icon>
              </div>
              <div class="slds-resizable">
                <span class="slds-resizable__handle">
                  <span
                    class="slds-resizable__divider"
                    data-column="MessageType"
                    onmousedown={handleStartResize}
                  ></span>
                </span>
              </div>
            </th>
            <th class="slds-is-resizable" data-column="Subject" scope="col">
              <div
                class="slds-truncate slds-p-horizontal_xx-small"
                title="
                      Subject"
              >
                Subject
              </div>
              <div class="slds-resizable">
                <span class="slds-resizable__handle">
                  <span
                    class="slds-resizable__divider"
                    data-column="Subject"
                    onmousedown={handleStartResize}
                  ></span>
                </span>
              </div>
            </th>
            <th class="slds-is-resizable" data-column="Sent" scope="col">
              <div
                class="slds-truncate slds-p-horizontal_xx-small"
                title="	
                      Sent"
              >
                <span class="sortBtn" data-field="Sent__c" onclick={handleSort}
                  >Sent</span
                >
                <lightning-icon
                  if:true={isSentSortedAsc}
                  icon-name="utility:arrowup"
                  size="xx-small"
                >
                </lightning-icon>
                <lightning-icon
                  if:true={isSentSortedDesc}
                  icon-name="utility:arrowdown"
                  size="xx-small"
                ></lightning-icon>
              </div>
              <div class="slds-resizable">
                <span class="slds-resizable__handle">
                  <span
                    class="slds-resizable__divider"
                    data-column="Sent"
                    onmousedown={handleStartResize}
                  ></span>
                </span>
              </div>
            </th>
            <th class="slds-is-resizable" data-column="Message" scope="col">
              <div
                class="slds-truncate slds-p-horizontal_xx-small"
                title="	
                      Message"
              >
                Message
              </div>
              <div class="slds-resizable">
                <span class="slds-resizable__handle">
                  <span
                    class="slds-resizable__divider"
                    data-column="Message"
                    onmousedown={handleStartResize}
                  ></span>
                </span>
              </div>
            </th>
            <th class="slds-is-resizable" data-column="RelatedLink" scope="col">
              <div
                class="slds-truncate slds-p-horizontal_xx-small"
                title="relateddoc"
              >
                Related Link
              </div>
              <div class="slds-resizable">
                <span class="slds-resizable__handle">
                  <span
                    class="slds-resizable__divider"
                    data-column="RelatedLink"
                    onmousedown={handleStartResize}
                  ></span>
                </span>
              </div>
            </th>
            <th
              class="slds-is-resizable"
              scope="col"
              style="width: 3.2rem"
            ></th>
          </tr>
        </thead>
        <tbody>
          <template for:each={paginatedRecords} for:item="item">
            <tr key={item.Id} class="slds-hint-parent">
              <template if:false={isParent}>
                <td
                  class="slds-text-align_right"
                  scope="col"
                  style="width: 3.25rem"
                >
                  <lightning-input
                    type="checkbox"
                    data-id={item.Id}
                    label=""
                    onchange={handleCheckboxChange}
                    checked={item.selected}
                  >
                  </lightning-input>
                </td>
              </template>
              <td data-label="Business Area" data-column="BusinessArea">
                <div class="slds-truncate">{item.Business_Area__c}</div>
              </td>
              <td data-label="Message Type" data-column="MessageType">
                <div class="slds-truncate">{item.Message_Type__c}</div>
              </td>
              <td data-label="Subject" data-column="Subject" scope="row">
                <div class="slds-truncate">
                  <template if:false={item.Is_Read__c}>
                    <div style="display: flex; gap: 3.5px; align-items: center">
                      <div class="darkBlueDot"></div>
                      <strong>
                        <lightning-button
                          variant="base"
                          data-id={item.Id}
                          onclick={handleSubjectAction}
                          label={item.Subject__c}
                        ></lightning-button>
                        <!-- <span data-id={item.Id} onclick={handleSubjectAction}  style="color: rgb(38 116 169); cursor: pointer;">{item.Subject__c}</span> -->
                      </strong>
                    </div>
                  </template>
                  <template if:true={item.Is_Read__c}>
                    <lightning-button
                      variant="base"
                      data-id={item.Id}
                      onclick={handleSubjectAction}
                      label={item.Subject__c}
                    ></lightning-button>
                  </template>
                </div>
              </td>
              <td data-label="Sent" data-column="Sent">
                <div class="slds-truncate">{item.formattedDate}</div>
              </td>
              <td data-label="Message" data-column="Message">
                <div class="slds-truncate">
                  <lightning-formatted-rich-text value={item.Message__c}>
                  </lightning-formatted-rich-text>
                </div>
              </td>
              <td class="slds-truncate" data-column="RelatedLink">
                <lightning-formatted-url
                  value={item.Related_Link__c}
                  tooltip="Related PDF"
                  target="_blank"
                >
                </lightning-formatted-url>
              </td>
              <td>
                <lightning-icon
                  style="cursor: pointer"
                  icon-name="utility:archive"
                  data-id={item.Id}
                  onclick={archiveSelectedRecords}
                  size="xx-small"
                ></lightning-icon>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </template>
    <template if:false={isParent}>
      <!-- Pagination Controls -->
      <div class="pagination">
        <lightning-button
          label="Previous"
          onclick={previousPage}
          disabled={isFirstPage}
          variant="brand-outline"
        >
        </lightning-button>

        <span>Page {currentPage} of {totalPages}</span>

        <lightning-button
          label="Next"
          onclick={nextPage}
          disabled={isLastPage}
          variant="brand-outline"
        >
        </lightning-button>
      </div>
    </template>
  </lightning-card>

  <template if:false={notifications.length}>
    <p class="slds-m-around_medium">No notifications available.</p>
  </template>
  <template if:true={isModalOpen}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
      <div class="slds-modal__container">
        <!-- Modal Header -->
        <header class="slds-modal__header">
          <h2 class="slds-modal__title slds-hyphenate">
            {selectedNotification.Subject__c}
          </h2>
        </header>

        <!-- Modal Body -->
        <div class="slds-modal__content slds-p-around_medium">
          <div
            style="display: flex; flex-direction: column; gap: 3px; width: 70%"
          >
            <p class="messageDetail">
              <strong>From:</strong>
              <span class="detailValues"> Customer Care </span>
            </p>
            <p class="messageDetail">
              <strong>To:</strong>
              <span class="detailValues">
                customer@customerdistribution.com
              </span>
            </p>
            <p class="messageDetail">
              <strong>Subject:</strong>
              <span class="detailValues">
                {selectedNotification.Subject__c}
              </span>
            </p>
            <p class="messageDetail">
              <strong>Sent Date:</strong>
              <span class="detailValues"> {selectedNotification.Sent__c} </span>
            </p>
          </div>
          <hr style="margin: 15px 0px" />

          <div class="slds-m-top_medium" style="color: gray">
            <lightning-formatted-rich-text
              value={selectedNotification.Message__c}
            >
            </lightning-formatted-rich-text>

            <div class="slds-m-top_medium">
              <img
                src={logoImageUrl}
                style="margin: 8px"
                width="150px"
                alt="logo"
              />
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <footer class="slds-modal__footer" style="text-align: center">
          <button
            class="slds-button slds-button_neutral"
            onclick={archiveSelectedRecords}
            style="color: red"
          >
            Archive
          </button>
          <button
            class="slds-button slds-button_destructive"
            onclick={closeModal}
          >
            Close
          </button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <template if:true={isPreferencesModalOpen}>
    <c-cz-preferences-modal
      onclose={closePreferencesModal}
    ></c-cz-preferences-modal>
  </template>
</template>
